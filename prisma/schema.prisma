// This is the Prisma schema file for NCISM Textbook Review System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password_hash String
  role          UserRole
  institution   String?
  created_at    DateTime  @default(now())
  last_login    DateTime?

  // Relations
  uploaded_books       Book[]              @relation("UploadedBy")
  assigned_reviews     Assignment[]        @relation("AssignedTo")
  created_assignments  Assignment[]        @relation("AssignedBy")
  submitted_reviews    Review[]            @relation("SubmittedBy")
  committee_decisions  CommitteeDecision[] @relation("DecidedBy")
  audit_actions        AuditLog[]          @relation("ActorLogs")

  @@map("users")
}

enum UserRole {
  ADMIN
  SECRETARIAT
  REVIEWER
  COMMITTEE
}

model Book {
  id              String   @id @default(uuid())
  title           String
  authors         String
  publisher       String
  edition         String
  syllabus_version String
  pdf_path        String
  uploaded_by     String
  uploaded_at     DateTime @default(now())
  status          BookStatus

  // Relations
  uploader           User                @relation("UploadedBy", fields: [uploaded_by], references: [id])
  assignments        Assignment[]        @relation("BookAssignments")
  aggregate_results  AggregateResult[]   @relation("BookResults")
  committee_decisions CommitteeDecision[] @relation("BookDecisions")

  @@map("books")
}

enum BookStatus {
  PENDING_REVIEW
  UNDER_REVIEW
  REVIEW_COMPLETED
  APPROVED
  REJECTED
  NEEDS_REVISION
}

model Assignment {
  id          String    @id @default(uuid())
  book_id     String
  reviewer_id String
  assigned_by String
  assigned_at DateTime  @default(now())
  due_date    DateTime
  status      AssignmentStatus

  // Relations
  book        Book      @relation("BookAssignments", fields: [book_id], references: [id])
  reviewer    User      @relation("AssignedTo", fields: [reviewer_id], references: [id])
  assigner    User      @relation("AssignedBy", fields: [assigned_by], references: [id])
  reviews     Review[]  @relation("AssignmentReviews")

  @@map("assignments")
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

model Criterion {
  id          String  @id @default(uuid())
  code        String  @unique
  label       String
  description String
  weight      Float

  @@map("criteria")
}

model Review {
  id           String    @id @default(uuid())
  assignment_id String
  reviewer_id  String
  scores       Json      // JSON object mapping criterion codes to scores
  comments     Json      // JSON object mapping criterion codes to comments
  submitted_at DateTime  @default(now())
  draft_flag   Boolean   @default(true)

  // Relations
  assignment   Assignment @relation("AssignmentReviews", fields: [assignment_id], references: [id])
  reviewer     User       @relation("SubmittedBy", fields: [reviewer_id], references: [id])

  @@map("reviews")
}

model AggregateResult {
  id           String   @id @default(uuid())
  book_id      String
  computed_at  DateTime @default(now())
  stats        Json     // JSON object with statistical data
  summary_text String   @db.Text

  // Relations
  book         Book     @relation("BookResults", fields: [book_id], references: [id])

  @@map("aggregate_results")
}

model CommitteeDecision {
  id         String   @id @default(uuid())
  book_id    String
  decided_by String
  decision   Decision
  rationale  String   @db.Text
  decided_at DateTime @default(now())

  // Relations
  book       Book     @relation("BookDecisions", fields: [book_id], references: [id])
  decider    User     @relation("DecidedBy", fields: [decided_by], references: [id])

  @@map("committee_decisions")
}

enum Decision {
  APPROVED
  REJECTED
  NEEDS_REVISION
}

model AuditLog {
  id          String   @id @default(uuid())
  actor_id    String
  action      String
  target_type String
  target_id   String
  timestamp   DateTime @default(now())
  details     Json?

  // Relations
  actor       User     @relation("ActorLogs", fields: [actor_id], references: [id])

  @@map("audit_logs")
}